<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>StakeTable</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../book.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/EspressoSystems/espresso-network" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="staketable"><a class="header" href="#staketable">StakeTable</a></h1>
<p><a href="https://github.com/EspressoSystems/espresso-network/blob/237062fb1c025188167b240d537e260a26f446d2/contracts/src/StakeTable.sol">Git Source</a></p>
<p><strong>Inherits:</strong>
Initializable, <a href="/contracts/src/InitializedAt.sol/contract.InitializedAt.html">InitializedAt</a>, OwnableUpgradeable, UUPSUpgradeable</p>
<p><strong>Title:</strong>
Ethereum L1 component of the Espresso Global Confirmation Layer (GCL) stake table.</p>
<p>All functions are marked as virtual so that future upgrades can override them.</p>
<h2 id="state-variables"><a class="header" href="#state-variables">State Variables</a></h2>
<h3 id="lightclient"><a class="header" href="#lightclient">lightClient</a></h3>
<p>Reference to the light client contract.</p>
<p>Currently unused but will be used for slashing therefore already included in the
contract.</p>
<pre><code class="language-solidity">ILightClient public lightClient
</code></pre>
<h3 id="token"><a class="header" href="#token">token</a></h3>
<p>The staking token contract.</p>
<pre><code class="language-solidity">ERC20 public token
</code></pre>
<h3 id="validators"><a class="header" href="#validators">validators</a></h3>
<p>All validators the contract knows about.</p>
<pre><code class="language-solidity">mapping(address account =&gt; Validator validator) public validators
</code></pre>
<h3 id="blskeys"><a class="header" href="#blskeys">blsKeys</a></h3>
<p>BLS keys that have been seen by the contract</p>
<p>to simplify the reasoning about what keys and prevent some errors due to
misconfigurations of validators the contract currently marks keys as used and only allow
them to be used once. This for example prevents callers from accidentally registering the
same BLS key twice.</p>
<pre><code class="language-solidity">mapping(bytes32 blsKeyHash =&gt; bool used) public blsKeys
</code></pre>
<h3 id="validatorexits"><a class="header" href="#validatorexits">validatorExits</a></h3>
<p>Validators that have exited and the time at which delegators can claim their funds.</p>
<pre><code class="language-solidity">mapping(address validator =&gt; uint256 unlocksAt) public validatorExits
</code></pre>
<h3 id="delegations"><a class="header" href="#delegations">delegations</a></h3>
<p>Currently active delegation amounts.</p>
<pre><code class="language-solidity">mapping(address validator =&gt; mapping(address delegator =&gt; uint256 amount)) public delegations
</code></pre>
<h3 id="undelegations"><a class="header" href="#undelegations">undelegations</a></h3>
<p>Delegations held in escrow that are to be unlocked at a later time.</p>
<pre><code class="language-solidity">mapping(address validator =&gt; mapping(address delegator =&gt; Undelegation)) public undelegations
</code></pre>
<h3 id="exitescrowperiod"><a class="header" href="#exitescrowperiod">exitEscrowPeriod</a></h3>
<p>The time (seconds) the contract will hold funds after undelegations are requested.
Must allow ample time for node to exit active validator set and slashing
evidence to be submitted.</p>
<pre><code class="language-solidity">uint256 public exitEscrowPeriod
</code></pre>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="constructor"><a class="header" href="#constructor">constructor</a></h3>
<p>since the constructor initializes storage on this contract we disable it</p>
<p>storage is on the proxy contract since it calls this contract via delegatecall</p>
<p><strong>Note:</strong>
oz-upgrades-unsafe-allow: constructor</p>
<pre><code class="language-solidity">constructor() ;
</code></pre>
<h3 id="initialize"><a class="header" href="#initialize">initialize</a></h3>
<pre><code class="language-solidity">function initialize(
    address _tokenAddress,
    address _lightClientAddress,
    uint256 _exitEscrowPeriod,
    address _timelock
) public initializer;
</code></pre>
<h3 id="initializestate"><a class="header" href="#initializestate">initializeState</a></h3>
<p>Initialize the state of the contract</p>
<pre><code class="language-solidity">function initializeState(
    address _tokenAddress,
    address _lightClientAddress,
    uint256 _exitEscrowPeriod
) internal;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_tokenAddress</code></td><td><code>address</code></td><td>The address of the staking token</td></tr>
<tr><td><code>_lightClientAddress</code></td><td><code>address</code></td><td>The address of the light client</td></tr>
<tr><td><code>_exitEscrowPeriod</code></td><td><code>uint256</code></td><td>The exit escrow period. Set to uint64.max to disable the exit escrow period.</td></tr>
</tbody></table>
</div>
<h3 id="getversion"><a class="header" href="#getversion">getVersion</a></h3>
<p>Use this to get the implementation contract version</p>
<pre><code class="language-solidity">function getVersion()
    public
    pure
    virtual
    returns (uint8 majorVersion, uint8 minorVersion, uint8 patchVersion);
</code></pre>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>majorVersion</code></td><td><code>uint8</code></td><td>The major version of the contract</td></tr>
<tr><td><code>minorVersion</code></td><td><code>uint8</code></td><td>The minor version of the contract</td></tr>
<tr><td><code>patchVersion</code></td><td><code>uint8</code></td><td>The patch version of the contract</td></tr>
</tbody></table>
</div>
<h3 id="_authorizeupgrade"><a class="header" href="#_authorizeupgrade">_authorizeUpgrade</a></h3>
<p>only the timelock can authorize an upgrade</p>
<pre><code class="language-solidity">function _authorizeUpgrade(address newImplementation) internal virtual override onlyOwner;
</code></pre>
<h3 id="renounceownership"><a class="header" href="#renounceownership">renounceOwnership</a></h3>
<p>Prevent renouncing ownership to preserve governance control.</p>
<p>Override renounceOwnership() to revert, preventing accidental or malicious ownership
renunciation</p>
<pre><code class="language-solidity">function renounceOwnership() public virtual override onlyOwner;
</code></pre>
<h3 id="_hashblskey"><a class="header" href="#_hashblskey">_hashBlsKey</a></h3>
<p>Computes a hash value of some G2 point.</p>
<pre><code class="language-solidity">function _hashBlsKey(BN254.G2Point memory blsVK) public pure returns (bytes32);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>blsVK</code></td><td><code>BN254.G2Point</code></td><td>BLS verification key in G2</td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>bytes32</code></td><td>keccak256(blsVK)</td></tr>
</tbody></table>
</div>
<h3 id="ensurevalidatoractive"><a class="header" href="#ensurevalidatoractive">ensureValidatorActive</a></h3>
<pre><code class="language-solidity">function ensureValidatorActive(address validator) internal view;
</code></pre>
<h3 id="ensurevalidatornotregistered"><a class="header" href="#ensurevalidatornotregistered">ensureValidatorNotRegistered</a></h3>
<pre><code class="language-solidity">function ensureValidatorNotRegistered(address validator) internal view;
</code></pre>
<h3 id="ensurenewkey"><a class="header" href="#ensurenewkey">ensureNewKey</a></h3>
<pre><code class="language-solidity">function ensureNewKey(BN254.G2Point memory blsVK) internal view;
</code></pre>
<h3 id="ensurenonzeroschnorrkey"><a class="header" href="#ensurenonzeroschnorrkey">ensureNonZeroSchnorrKey</a></h3>
<pre><code class="language-solidity">function ensureNonZeroSchnorrKey(EdOnBN254.EdOnBN254Point memory schnorrVK) internal pure;
</code></pre>
<h3 id="registervalidator"><a class="header" href="#registervalidator">registerValidator</a></h3>
<p>Register a validator in the stake table</p>
<p>The function will revert if</p>
<ol>
<li>the validator is already registered</li>
<li>the schnorr key is zero</li>
<li>if the bls signature verification fails (this prevents rogue public-key attacks).</li>
<li>the commission is &gt; 100%</li>
</ol>
<p>No validity check on <code>schnorrVK</code> due to gas cost of Rescue hash, UIs should perform
checks where possible and alert users.</p>
<pre><code class="language-solidity">function registerValidator(
    BN254.G2Point memory blsVK,
    EdOnBN254.EdOnBN254Point memory schnorrVK,
    BN254.G1Point memory blsSig,
    uint16 commission
) external virtual;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>blsVK</code></td><td><code>BN254.G2Point</code></td><td>The BLS verification key</td></tr>
<tr><td><code>schnorrVK</code></td><td><code>EdOnBN254.EdOnBN254Point</code></td><td>The Schnorr verification key (as the auxiliary info)</td></tr>
<tr><td><code>blsSig</code></td><td><code>BN254.G1Point</code></td><td>The BLS signature that authenticates the ethereum account this function is called from</td></tr>
<tr><td><code>commission</code></td><td><code>uint16</code></td><td>in % with 2 decimals, from 0.00% (value 0) to 100% (value 10_000)</td></tr>
</tbody></table>
</div>
<h3 id="deregistervalidator"><a class="header" href="#deregistervalidator">deregisterValidator</a></h3>
<p>Deregister a validator</p>
<pre><code class="language-solidity">function deregisterValidator() public virtual;
</code></pre>
<h3 id="delegate"><a class="header" href="#delegate">delegate</a></h3>
<p>Delegate to a validator</p>
<pre><code class="language-solidity">function delegate(address validator, uint256 amount) public virtual;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>validator</code></td><td><code>address</code></td><td>The validator to delegate to</td></tr>
<tr><td><code>amount</code></td><td><code>uint256</code></td><td>The amount to delegate</td></tr>
</tbody></table>
</div>
<h3 id="undelegate"><a class="header" href="#undelegate">undelegate</a></h3>
<p>Undelegate from a validator</p>
<pre><code class="language-solidity">function undelegate(address validator, uint256 amount) public virtual;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>validator</code></td><td><code>address</code></td><td>The validator to undelegate from</td></tr>
<tr><td><code>amount</code></td><td><code>uint256</code></td><td>The amount to undelegate</td></tr>
</tbody></table>
</div>
<h3 id="claimwithdrawal"><a class="header" href="#claimwithdrawal">claimWithdrawal</a></h3>
<p>Withdraw previously delegated funds after an undelegation.</p>
<pre><code class="language-solidity">function claimWithdrawal(address validator) public virtual;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>validator</code></td><td><code>address</code></td><td>The validator to withdraw from</td></tr>
</tbody></table>
</div>
<h3 id="claimvalidatorexit"><a class="header" href="#claimvalidatorexit">claimValidatorExit</a></h3>
<p>Withdraw previously delegated funds after a validator has exited</p>
<pre><code class="language-solidity">function claimValidatorExit(address validator) public virtual;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>validator</code></td><td><code>address</code></td><td>The validator to withdraw from</td></tr>
</tbody></table>
</div>
<h3 id="updateconsensuskeys"><a class="header" href="#updateconsensuskeys">updateConsensusKeys</a></h3>
<p>Update the consensus keys for a validator</p>
<p>This function is used to update the consensus keys for a validator</p>
<p>This function can only be called by the validator itself when it hasn't exited</p>
<p>The validator will need to give up either its old BLS key and/or old Schnorr key</p>
<p>The validator will need to provide a BLS signature to prove that the account owns the
new BLS key</p>
<pre><code class="language-solidity">function updateConsensusKeys(
    BN254.G2Point memory newBlsVK,
    EdOnBN254.EdOnBN254Point memory newSchnorrVK,
    BN254.G1Point memory newBlsSig
) external virtual;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>newBlsVK</code></td><td><code>BN254.G2Point</code></td><td>The new BLS verification key</td></tr>
<tr><td><code>newSchnorrVK</code></td><td><code>EdOnBN254.EdOnBN254Point</code></td><td>The new Schnorr verification key</td></tr>
<tr><td><code>newBlsSig</code></td><td><code>BN254.G1Point</code></td><td>The BLS signature that the account owns the new BLS key</td></tr>
</tbody></table>
</div>
<h2 id="events"><a class="header" href="#events">Events</a></h2>
<h3 id="validatorregistered"><a class="header" href="#validatorregistered">ValidatorRegistered</a></h3>
<p>A registration of a new validator.</p>
<p>Signals to the confirmation layer that a new validator is ready to receive
delegations in the stake table contract. The confirmation layer uses this event to keep
track of the validator's keys for the stake table.</p>
<p>The commission is in % with 2 decimals, from 0.00% (value 0) to 100% (value 10_000).</p>
<p>A validator registration is only valid if the BLS and Schnorr signature are valid.
The GCL must verify this and otherwise discard the validator registration when it processes
the event. The contract cannot verify the validity of the registration event and delegators
will be able to deposit as soon as this event is emitted. In the event that a delegator
delegates to an invalid validator the delegator can withdraw the delegation again in the
same way they can withdraw other delegations.</p>
<p>UIs should do their best to prevent invalid, or duplicate registrations.</p>
<p>The verification key of the BLS keypair used for consensus signing is a
<code>BN254.G2Point</code>.</p>
<p>The verification key of the state signing schnorr keypair is an
<code>EdOnBN254.EdOnBN254Point</code>.</p>
<pre><code class="language-solidity">event ValidatorRegistered(
    address indexed account,
    BN254.G2Point blsVk,
    EdOnBN254.EdOnBN254Point schnorrVk,
    uint16 commission
);
</code></pre>
<h3 id="validatorexit"><a class="header" href="#validatorexit">ValidatorExit</a></h3>
<p>A validator initiated an exit from stake table</p>
<p>All funds delegated to this validator are marked for withdrawal. Users can no longer
delegate to this validator. Their previously delegated funds are automatically undelegated.
After <code>exitEscrowPeriod</code> elapsed, delegators can claim the funds delegated to the exited
validator via <code>claimValidatorExit</code>.</p>
<p>The GCL removes this validator and all its delegations from the active validator
set.</p>
<pre><code class="language-solidity">event ValidatorExit(address indexed validator);
</code></pre>
<h3 id="delegated"><a class="header" href="#delegated">Delegated</a></h3>
<p>A Delegator delegated funds to a validator.</p>
<p>The tokens are transferred to the stake table contract.</p>
<p>The GCL adjusts the weight for this validator and the delegators delegation
associated with it.</p>
<pre><code class="language-solidity">event Delegated(address indexed delegator, address indexed validator, uint256 amount);
</code></pre>
<h3 id="undelegated"><a class="header" href="#undelegated">Undelegated</a></h3>
<p>A delegator undelegation funds from a validator.</p>
<p>The tokens are marked to be unlocked for withdrawal.</p>
<p>The GCL needs to update the stake table and adjust the weight for this validator and
the delegators delegation associated with it.</p>
<pre><code class="language-solidity">event Undelegated(address indexed delegator, address indexed validator, uint256 amount);
</code></pre>
<h3 id="consensuskeysupdated"><a class="header" href="#consensuskeysupdated">ConsensusKeysUpdated</a></h3>
<p>A validator updates their signing keys.</p>
<p>Similarly to registration events, the correctness cannot be fully determined by the
contracts.</p>
<p>The confirmation layer needs to update the stake table with the new keys.</p>
<pre><code class="language-solidity">event ConsensusKeysUpdated(
    address indexed account, BN254.G2Point blsVK, EdOnBN254.EdOnBN254Point schnorrVK
);
</code></pre>
<h3 id="withdrawal"><a class="header" href="#withdrawal">Withdrawal</a></h3>
<p>A delegator claims unlocked funds.</p>
<p>This event is not relevant for the GCL. The events that remove stake from the stake
table are <code>Undelegated</code> and <code>ValidatorExit</code>.</p>
<pre><code class="language-solidity">event Withdrawal(address indexed account, uint256 amount);
</code></pre>
<h2 id="errors"><a class="header" href="#errors">Errors</a></h2>
<h3 id="validatoralreadyregistered"><a class="header" href="#validatoralreadyregistered">ValidatorAlreadyRegistered</a></h3>
<p>A user tries to register a validator with the same address</p>
<pre><code class="language-solidity">error ValidatorAlreadyRegistered();
</code></pre>
<h3 id="validatorinactive"><a class="header" href="#validatorinactive">ValidatorInactive</a></h3>
<pre><code class="language-solidity">error ValidatorInactive();
</code></pre>
<h3 id="validatoralreadyexited"><a class="header" href="#validatoralreadyexited">ValidatorAlreadyExited</a></h3>
<p>A validator has already exited.</p>
<pre><code class="language-solidity">error ValidatorAlreadyExited();
</code></pre>
<h3 id="validatornotexited"><a class="header" href="#validatornotexited">ValidatorNotExited</a></h3>
<p>A validator has not exited yet.</p>
<pre><code class="language-solidity">error ValidatorNotExited();
</code></pre>
<h3 id="prematurewithdrawal"><a class="header" href="#prematurewithdrawal">PrematureWithdrawal</a></h3>
<pre><code class="language-solidity">error PrematureWithdrawal();
</code></pre>
<h3 id="insufficientallowance"><a class="header" href="#insufficientallowance">InsufficientAllowance</a></h3>
<pre><code class="language-solidity">error InsufficientAllowance(uint256, uint256);
</code></pre>
<h3 id="insufficientbalance"><a class="header" href="#insufficientbalance">InsufficientBalance</a></h3>
<pre><code class="language-solidity">error InsufficientBalance(uint256);
</code></pre>
<h3 id="nothingtowithdraw"><a class="header" href="#nothingtowithdraw">NothingToWithdraw</a></h3>
<pre><code class="language-solidity">error NothingToWithdraw();
</code></pre>
<h3 id="invalidschnorrvk"><a class="header" href="#invalidschnorrvk">InvalidSchnorrVK</a></h3>
<pre><code class="language-solidity">error InvalidSchnorrVK();
</code></pre>
<h3 id="blskeyalreadyused"><a class="header" href="#blskeyalreadyused">BlsKeyAlreadyUsed</a></h3>
<p>The BLS key has been previously registered in the contract.</p>
<pre><code class="language-solidity">error BlsKeyAlreadyUsed();
</code></pre>
<h3 id="invalidcommission"><a class="header" href="#invalidcommission">InvalidCommission</a></h3>
<p>The commission value is invalid.</p>
<pre><code class="language-solidity">error InvalidCommission();
</code></pre>
<h3 id="zeroaddress"><a class="header" href="#zeroaddress">ZeroAddress</a></h3>
<p>Contract dependencies initialized with zero address.</p>
<pre><code class="language-solidity">error ZeroAddress();
</code></pre>
<h3 id="undelegationalreadyexists"><a class="header" href="#undelegationalreadyexists">UndelegationAlreadyExists</a></h3>
<p>An undelegation already exists for this validator and delegator.</p>
<pre><code class="language-solidity">error UndelegationAlreadyExists();
</code></pre>
<h3 id="zeroamount"><a class="header" href="#zeroamount">ZeroAmount</a></h3>
<p>A zero amount would lead to a no-op.</p>
<pre><code class="language-solidity">error ZeroAmount();
</code></pre>
<h3 id="ownershipcannotberenounced"><a class="header" href="#ownershipcannotberenounced">OwnershipCannotBeRenounced</a></h3>
<p>Attempted to renounce ownership which would break governance controls.</p>
<pre><code class="language-solidity">error OwnershipCannotBeRenounced();
</code></pre>
<h3 id="exitescrowperiodinvalid"><a class="header" href="#exitescrowperiodinvalid">ExitEscrowPeriodInvalid</a></h3>
<p>The exit escrow period is invalid (either too short or too long)</p>
<pre><code class="language-solidity">error ExitEscrowPeriodInvalid();
</code></pre>
<h2 id="structs"><a class="header" href="#structs">Structs</a></h2>
<h3 id="validator"><a class="header" href="#validator">Validator</a></h3>
<p>Represents an Espresso validator and tracks funds currently delegated to them.</p>
<p>The <code>delegatedAmount</code> excludes funds that are currently marked for withdrawal via
undelegation or validator exit.</p>
<pre><code class="language-solidity">struct Validator {
    uint256 delegatedAmount;
    ValidatorStatus status;
}
</code></pre>
<h3 id="undelegation"><a class="header" href="#undelegation">Undelegation</a></h3>
<p>Tracks an undelegation from a validator.</p>
<pre><code class="language-solidity">struct Undelegation {
    uint256 amount;
    uint256 unlocksAt;
}
</code></pre>
<h2 id="enums"><a class="header" href="#enums">Enums</a></h2>
<h3 id="validatorstatus"><a class="header" href="#validatorstatus">ValidatorStatus</a></h3>
<p>The status of a validator.
By default a validator is in the <code>Unknown</code> state. This means it has never registered. Upon
registration the status will become <code>Active</code> and if the validator deregisters its status
becomes <code>Exited</code>.</p>
<pre><code class="language-solidity">enum ValidatorStatus {
    Unknown,
    Active,
    Exited
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../contracts/src/SafeExitTimelock.sol/contract.SafeExitTimelock.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../contracts/src/StakeTableV2.sol/contract.StakeTableV2.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../contracts/src/SafeExitTimelock.sol/contract.SafeExitTimelock.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../contracts/src/StakeTableV2.sol/contract.StakeTableV2.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../solidity.min.js"></script>



    </div>
    </body>
</html>
