ALTER TABLE header RENAME TO header_unpartitioned;

-- Create new partitioned `header` table
CREATE TABLE header (
    height       BIGINT PRIMARY KEY,
    hash         VARCHAR NOT NULL,
    payload_hash VARCHAR NOT NULL,
    timestamp    BIGINT NOT NULL,
    data         JSONB NOT NULL
) PARTITION BY RANGE (height);

-- Create `header` partitions (each covering 500,000 blocks)
CREATE TABLE header_p0 PARTITION OF header FOR VALUES FROM (0) TO (500000);
CREATE TABLE header_p1 PARTITION OF header FOR VALUES FROM (500000) TO (1000000);
CREATE TABLE header_p2 PARTITION OF header FOR VALUES FROM (1000000) TO (1500000);
CREATE TABLE header_p3 PARTITION OF header FOR VALUES FROM (1500000) TO (2000000);
CREATE TABLE header_p4 PARTITION OF header FOR VALUES FROM (2000000) TO (2500000);
CREATE TABLE header_p5 PARTITION OF header FOR VALUES FROM (2500000) TO (3000000);
CREATE TABLE header_p6 PARTITION OF header FOR VALUES FROM (3000000) TO (3500000);
CREATE TABLE header_p7 PARTITION OF header FOR VALUES FROM (3500000) TO (4000000);
CREATE TABLE header_p8 PARTITION OF header FOR VALUES FROM (4000000) TO (4500000);
CREATE TABLE header_p9 PARTITION OF header FOR VALUES FROM (4500000) TO (5000000);
CREATE TABLE header_p10 PARTITION OF header FOR VALUES FROM (5000000) TO (5500000);
CREATE TABLE header_p11 PARTITION OF header FOR VALUES FROM (5500000) TO (6000000);
CREATE TABLE header_p12 PARTITION OF header FOR VALUES FROM (6000000) TO (6500000);
CREATE TABLE header_p13 PARTITION OF header FOR VALUES FROM (6500000) TO (7000000);
CREATE TABLE header_p14 PARTITION OF header FOR VALUES FROM (7000000) TO (7500000);
CREATE TABLE header_p15 PARTITION OF header FOR VALUES FROM (7500000) TO (8000000);

CREATE INDEX header2_timestamp_idx ON header (timestamp);
CREATE INDEX header2_payload_hash_idx ON header (payload_hash);

-- migrate data to paritioned table
-- INSERT INTO header
-- SELECT * FROM header_unpartitioned;

ALTER TABLE payload RENAME TO payload_unpartitioned;

CREATE TABLE payload (
    height BIGINT PRIMARY KEY REFERENCES header(height) ON DELETE CASCADE,
    size   INTEGER,
    data   BYTEA,
    num_transactions INTEGER
) PARTITION BY RANGE (height);

-- Create `payload` partitions (500k height ranges)
CREATE TABLE payload_p0 PARTITION OF payload FOR VALUES FROM (0) TO (500000);
CREATE TABLE payload_p1 PARTITION OF payload FOR VALUES FROM (500000) TO (1000000);
CREATE TABLE payload_p2 PARTITION OF payload FOR VALUES FROM (1000000) TO (1500000);
CREATE TABLE payload_p3 PARTITION OF payload FOR VALUES FROM (1500000) TO (2000000);
CREATE TABLE payload_p4 PARTITION OF payload FOR VALUES FROM (2000000) TO (2500000);
CREATE TABLE payload_p5 PARTITION OF payload FOR VALUES FROM (2500000) TO (3000000);
CREATE TABLE payload_p6 PARTITION OF payload FOR VALUES FROM (3000000) TO (3500000);
CREATE TABLE payload_p7 PARTITION OF payload FOR VALUES FROM (3500000) TO (4000000);
CREATE TABLE payload_p8 PARTITION OF payload FOR VALUES FROM (4000000) TO (4500000);
CREATE TABLE payload_p9 PARTITION OF payload FOR VALUES FROM (4500000) TO (5000000);
CREATE TABLE payload_p10 PARTITION OF payload FOR VALUES FROM (5000000) TO (5500000);
CREATE TABLE payload_p11 PARTITION OF payload FOR VALUES FROM (5500000) TO (6000000);
CREATE TABLE payload_p12 PARTITION OF payload FOR VALUES FROM (6000000) TO (6500000);
CREATE TABLE payload_p13 PARTITION OF payload FOR VALUES FROM (6500000) TO (7000000);
CREATE TABLE payload_p14 PARTITION OF payload FOR VALUES FROM (7000000) TO (7500000);
CREATE TABLE payload_p15 PARTITION OF payload FOR VALUES FROM (7500000) TO (8000000);

-- migrate data
-- INSERT INTO payload SELECT * FROM payload_unpartitioned;

ALTER TABLE leaf2 RENAME TO leaf2_unpartitioned;

CREATE TABLE leaf2 (
    height     BIGINT PRIMARY KEY REFERENCES header(height) ON DELETE CASCADE,
    hash       VARCHAR NOT NULL,
    block_hash VARCHAR NOT NULL,
    leaf       JSONB NOT NULL,
    qc         JSONB NOT NULL
) PARTITION BY RANGE (height);

-- `leaf2` partitions
CREATE TABLE leaf2_p0 PARTITION OF leaf2 FOR VALUES FROM (0) TO (500000);
CREATE TABLE leaf2_p1 PARTITION OF leaf2 FOR VALUES FROM (500000) TO (1000000);
CREATE TABLE leaf2_p2 PARTITION OF leaf2 FOR VALUES FROM (1000000) TO (1500000);
CREATE TABLE leaf2_p3 PARTITION OF leaf2 FOR VALUES FROM (1500000) TO (2000000);
CREATE TABLE leaf2_p4 PARTITION OF leaf2 FOR VALUES FROM (2000000) TO (2500000);
CREATE TABLE leaf2_p5 PARTITION OF leaf2 FOR VALUES FROM (2500000) TO (3000000);
CREATE TABLE leaf2_p6 PARTITION OF leaf2 FOR VALUES FROM (3000000) TO (3500000);
CREATE TABLE leaf2_p7 PARTITION OF leaf2 FOR VALUES FROM (3500000) TO (4000000);
CREATE TABLE leaf2_p8 PARTITION OF leaf2 FOR VALUES FROM (4000000) TO (4500000);
CREATE TABLE leaf2_p9 PARTITION OF leaf2 FOR VALUES FROM (4500000) TO (5000000);
CREATE TABLE leaf2_p10 PARTITION OF leaf2 FOR VALUES FROM (5000000) TO (5500000);
CREATE TABLE leaf2_p11 PARTITION OF leaf2 FOR VALUES FROM (5500000) TO (6000000);
CREATE TABLE leaf2_p12 PARTITION OF leaf2 FOR VALUES FROM (6000000) TO (6500000);
CREATE TABLE leaf2_p13 PARTITION OF leaf2 FOR VALUES FROM (6500000) TO (7000000);
CREATE TABLE leaf2_p14 PARTITION OF leaf2 FOR VALUES FROM (7000000) TO (7500000);
CREATE TABLE leaf2_p15 PARTITION OF leaf2 FOR VALUES FROM (7500000) TO (8000000);

-- migrate data
-- INSERT INTO leaf2 SELECT * FROM leaf2_unpartitioned;


ALTER TABLE vid2 RENAME TO vid2_unpartitioned;


CREATE TABLE vid2 (
    height BIGINT PRIMARY KEY REFERENCES header(height) ON DELETE CASCADE,
    common BYTEA NOT NULL,
    share  BYTEA
) PARTITION BY RANGE (height);

-- vid2 partitions
CREATE TABLE vid2_p0 PARTITION OF vid2 FOR VALUES FROM (0) TO (500000);
CREATE TABLE vid2_p1 PARTITION OF vid2 FOR VALUES FROM (500000) TO (1000000);
CREATE TABLE vid2_p2 PARTITION OF vid2 FOR VALUES FROM (1000000) TO (1500000);
CREATE TABLE vid2_p3 PARTITION OF vid2 FOR VALUES FROM (1500000) TO (2000000);
CREATE TABLE vid2_p4 PARTITION OF vid2 FOR VALUES FROM (2000000) TO (2500000);
CREATE TABLE vid2_p5 PARTITION OF vid2 FOR VALUES FROM (2500000) TO (3000000);
CREATE TABLE vid2_p6 PARTITION OF vid2 FOR VALUES FROM (3000000) TO (3500000);
CREATE TABLE vid2_p7 PARTITION OF vid2 FOR VALUES FROM (3500000) TO (4000000);
CREATE TABLE vid2_p8 PARTITION OF vid2 FOR VALUES FROM (4000000) TO (4500000);
CREATE TABLE vid2_p9 PARTITION OF vid2 FOR VALUES FROM (4500000) TO (5000000);
CREATE TABLE vid2_p10 PARTITION OF vid2 FOR VALUES FROM (5000000) TO (5500000);
CREATE TABLE vid2_p11 PARTITION OF vid2 FOR VALUES FROM (5500000) TO (6000000);
CREATE TABLE vid2_p12 PARTITION OF vid2 FOR VALUES FROM (6000000) TO (6500000);
CREATE TABLE vid2_p13 PARTITION OF vid2 FOR VALUES FROM (6500000) TO (7000000);
CREATE TABLE vid2_p14 PARTITION OF vid2 FOR VALUES FROM (7000000) TO (7500000);
CREATE TABLE vid2_p15 PARTITION OF vid2 FOR VALUES FROM (7500000) TO (8000000);

-- -- migrate data
-- INSERT INTO vid2 SELECT * FROM vid2_unpartitioned;
