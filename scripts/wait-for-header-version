#!/usr/bin/env bash
set -euo pipefail

SEQUENCER_URL="${1:-http://localhost:24000}"
TARGET_MINOR_VERSION="${2:-4}"

echo "Waiting for sequencer to upgrade to version 0.${TARGET_MINOR_VERSION}..."
echo "Connecting to sequencer header stream at ${SEQUENCER_URL}..."

WS_URL=$(echo "$SEQUENCER_URL" | sed 's|^http://|ws://|' | sed 's|^https://|wss://|')

while true; do
  # Temporarily disable pipefail so we can check PIPESTATUS after the pipeline completes
  set +o pipefail
  websocat "${WS_URL}/v0/availability/stream/headers/0" 2>&1 | \
    while read -r line; do
      echo "$line" | jq -r '"v0.\(.version.Version.minor) height=\(.fields.height)"' 2>/dev/null || echo "$line"
      minor=$(echo "$line" | jq -r '.version.Version.minor' 2>/dev/null || echo "")
      if [ "$minor" = "$TARGET_MINOR_VERSION" ]; then
        echo "Version 0.${TARGET_MINOR_VERSION} detected!"
        exit 0
      fi
    done

  # Check the exit code of the while loop (last command in pipeline)
  # PIPESTATUS[0] = websocat, PIPESTATUS[1] = while loop
  pipe_status=("${PIPESTATUS[@]}")
  set -o pipefail

  while_exit=${pipe_status[1]}

  if [ "$while_exit" -eq 0 ]; then
    # while loop exited successfully - version was found
    exit 0
  fi

  # Connection failed, retry
  echo "Connection failed or stream interrupted, retrying in 5 seconds..."
  sleep 5
done
