#!/bin/bash
set -e

if [[ -z "${ESPRESSO_SEQUENCER_LIGHTCLIENT_ADDRESS}" ]]; then
  if [[ "${ESPRESSO_SEQUENCER_DEPLOY_LIGHTCLIENT_CONTRACT}" ]]; then
    echo "Light client contract address not found, deploying it now."
    ./gen-demo-contract --contracts-root-dir="./contracts"
    forge fmt
    forge build
    ESPRESSO_SEQUENCER_LIGHTCLIENT_ADDRESS=$(forge script contracts/script/LightClientTest.s.sol --fork-url $ESPRESSO_SEQUENCER_L1_PROVIDER --broadcast 2>/dev/null | grep "Contract Address:" | tail -1 | sed "s/^.*: //")
  else
    echo "Light client contract address not found"
  fi
fi

./state-prover -d --light-client-address $ESPRESSO_SEQUENCER_LIGHTCLIENT_ADDRESS
