name: Deployment Info

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: "0 6 * * *" # daily at 6am UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || 'main' }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  update-deployment-info:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      # No rust cache, we have limited capacity on github
      
      - name: Run deployment-info
        run: cargo run -p deployment-info

      - name: Check for changes
        id: changes
        run: |
          DIFF=$(git diff contracts/rust/deployment-info/deployments/)
          if [ -z "$DIFF" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "### Deployment info changes" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            echo "$DIFF" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if deployment info changed on PR
        if: github.event_name == 'pull_request' && steps.changes.outputs.changed == 'true'
        run: |
          echo "::error::Deployment info is out of date. Run 'cargo run -p deployment-info' and commit the changes."
          exit 1

      - name: Create PR with updated deployment info
        if: github.event_name != 'pull_request' && steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: update deployment info"
          title: "chore: update deployment info"
          body: |
            Automated update of deployment info from on-chain data.

            This PR was created by the deployment-info workflow.
          branch: auto/update-deployment-info
          base: main
          delete-branch: true
          labels: automated
